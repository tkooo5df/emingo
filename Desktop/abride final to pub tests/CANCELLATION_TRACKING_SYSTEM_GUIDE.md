# نظام تتبع الإلغاءات وإيقاف الحسابات

## نظرة عامة

تم تطوير نظام شامل لتتبع إلغاءات المستخدمين (السائقين والركاب) وإيقاف الحسابات تلقائياً عند تجاوز حد الإلغاءات المسموح به.

## الميزات الرئيسية

### 1. تتبع الإلغاءات
- **تسجيل تلقائي**: يتم تسجيل جميع الإلغاءات تلقائياً عند إلغاء رحلة أو حجز
- **تصنيف الإلغاءات**: 
  - إلغاء الرحلات (من السائقين)
  - إلغاء الحجوزات (من الركاب أو السائقين)
- **فترة التتبع**: آخر 15 يوم
- **الحد المسموح**: 3 إلغاءات في 15 يوم

### 2. إيقاف الحسابات التلقائي
- **إيقاف تلقائي**: عند الوصول لـ 3 إلغاءات في 15 يوم
- **رسالة واضحة**: "تم إيقاف الحساب بسبب تجاوز حد الإلغاءات"
- **منع الأنشطة**: لا يمكن للمستخدم الموقوف إنشاء رحلات أو حجوزات جديدة

### 3. رسائل التحذير
- **تحذير أول**: عند الإلغاء الأول
- **تحذير شديد**: عند الإلغاء الثاني
- **إيقاف نهائي**: عند الإلغاء الثالث

### 4. إدارة المدير
- **لوحة إدارة شاملة**: عرض جميع الإلغاءات والإيقافات
- **إحصائيات مفصلة**: عدد الإلغاءات حسب النوع والفترة
- **إعادة فتح الحسابات**: إمكانية إعادة فتح الحسابات الموقوفة

## الهيكل التقني

### جداول قاعدة البيانات

#### 1. جدول تتبع الإلغاءات (`cancellation_tracking`)
```sql
CREATE TABLE cancellation_tracking (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  user_type VARCHAR(20) NOT NULL CHECK (user_type IN ('driver', 'passenger')),
  cancellation_type VARCHAR(20) NOT NULL CHECK (cancellation_type IN ('trip_cancellation', 'booking_cancellation')),
  trip_id UUID REFERENCES trips(id),
  booking_id BIGINT REFERENCES bookings(id),
  cancellation_reason TEXT,
  cancelled_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 2. جدول إيقاف الحسابات (`account_suspensions`)
```sql
CREATE TABLE account_suspensions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id),
  suspension_type VARCHAR(20) NOT NULL CHECK (suspension_type IN ('cancellation_limit', 'manual', 'other')),
  suspension_reason TEXT NOT NULL,
  suspension_count INTEGER DEFAULT 1,
  suspended_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  suspended_by UUID REFERENCES auth.users(id),
  reactivated_at TIMESTAMP WITH TIME ZONE,
  reactivated_by UUID REFERENCES auth.users(id),
  reactivation_reason TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### الدوال المساعدة

#### 1. `get_cancellation_count_last_15_days(user_id, user_type)`
- تحسب عدد الإلغاءات للمستخدم في آخر 15 يوم
- ترجع عدد صحيح

#### 2. `is_user_suspended(user_id)`
- تتحقق من حالة إيقاف المستخدم
- ترجع `true` إذا كان المستخدم موقوف

#### 3. `suspend_user_account(user_id, suspension_type, suspension_reason, suspended_by)`
- توقف حساب المستخدم
- تحدث جدول `profiles` و `account_suspensions`
- ترجع معرف الإيقاف

#### 4. `reactivate_user_account(user_id, reactivation_reason, reactivated_by)`
- تعيد فتح حساب المستخدم
- تحدث سجل الإيقاف وتزيل حالة الإيقاف
- ترجع `true` عند النجاح

#### 5. `log_cancellation(user_id, user_type, cancellation_type, trip_id, booking_id, cancellation_reason)`
- تسجل الإلغاء وتحقق من الحد
- توقف الحساب تلقائياً عند الوصول للحد
- ترجع معرف الإلغاء

## المكونات المطورة

### 1. `CancellationManagement.tsx`
مكون إدارة الإلغاءات للمدير يتضمن:
- إحصائيات شاملة للإلغاءات
- جدول الحسابات الموقوفة
- إمكانية إعادة فتح الحسابات
- تحديث البيانات في الوقت الفعلي

### 2. `CancellationWarning.tsx`
مكون التحذيرات للمستخدمين يتضمن:
- عرض عدد الإلغاءات الحالي
- رسائل تحذيرية متدرجة
- رابط التواصل مع الدعم
- إمكانية إخفاء التحذير

### 3. تحديثات `AdminDashboard.tsx`
- إضافة تبويب "الإلغاءات"
- نظام تبويبات منظم (الحجوزات، الركاب، الإلغاءات)
- واجهة موحدة للإدارة

### 4. تحديثات `UserDashboard.tsx`
- إضافة مكون التحذيرات
- عرض التحذيرات في المكان المناسب

## التكامل مع النظام الحالي

### 1. تحديث `browserServices.ts`
تم إضافة الدوال التالية:
- `logCancellation()`: تسجيل الإلغاءات
- `getCancellationCountLast15Days()`: حساب عدد الإلغاءات
- `isUserSuspended()`: فحص حالة الإيقاف
- `suspendUserAccount()`: إيقاف الحساب
- `reactivateUserAccount()`: إعادة فتح الحساب
- `getUserCancellationHistory()`: تاريخ الإلغاءات
- `getAllSuspensions()`: جميع الإيقافات
- `getCancellationStatistics()`: إحصائيات الإلغاءات

### 2. تحديث دوال الإلغاء
- `updateBooking()`: تسجيل إلغاء الحجوزات
- `updateTrip()`: تسجيل إلغاء الرحلات
- `createTrip()`: فحص حالة الإيقاف قبل الإنشاء
- `createBooking()`: فحص حالة الإيقاف قبل الإنشاء

## سياسات الأمان (RLS)

### جدول `cancellation_tracking`
- المستخدمون يمكنهم رؤية إلغاءاتهم فقط
- المديرون يمكنهم رؤية جميع الإلغاءات

### جدول `account_suspensions`
- المستخدمون يمكنهم رؤية إيقافاتهم فقط
- المديرون يمكنهم إدارة جميع الإيقافات

## سيناريوهات الاستخدام

### 1. سائق يلغي رحلة
1. السائق يلغي رحلة من لوحة التحكم
2. النظام يسجل الإلغاء تلقائياً
3. إذا وصل للحد، يتم إيقاف الحساب
4. يظهر تحذير في لوحة التحكم

### 2. راكب يلغي حجز
1. الراكب يلغي حجز من لوحة التحكم
2. النظام يسجل الإلغاء تلقائياً
3. إذا وصل للحد، يتم إيقاف الحساب
4. يظهر تحذير في لوحة التحكم

### 3. مدير يدير الإيقافات
1. المدير يفتح تبويب "الإلغاءات"
2. يرى جميع الإحصائيات والإيقافات
3. يمكنه إعادة فتح الحسابات الموقوفة
4. يضيف سبب إعادة الفتح

## الرسائل والتنبيهات

### رسائل التحذير
- **إلغاء واحد**: "لقد قمت بإلغاء مرة واحدة في آخر 15 يوم..."
- **إلغاءان**: "لقد قمت بإلغاء مرتين في آخر 15 يوم..."
- **ثلاث إلغاءات**: "تم إيقاف حسابك بسبب تجاوز حد الإلغاءات..."

### رسائل المدير
- **إعادة فتح**: "تم إعادة فتح الحساب بنجاح"
- **خطأ**: "حدث خطأ في إعادة فتح الحساب"

## الأمان والخصوصية

### حماية البيانات
- جميع البيانات محمية بسياسات RLS
- المديرون فقط يمكنهم رؤية جميع البيانات
- المستخدمون يرون بياناتهم فقط

### السجلات والتدقيق
- جميع الإلغاءات والإيقافات مسجلة مع التواريخ
- تتبع من قام بالإيقاف أو إعادة الفتح
- أسباب واضحة لكل إجراء

## الصيانة والتطوير

### المراقبة
- مراقبة عدد الإلغاءات اليومية
- تتبع الحسابات الموقوفة
- مراجعة أسباب الإلغاءات

### التحسينات المستقبلية
- إضافة إشعارات للمديرين عند الإيقافات
- نظام استئناف للإيقافات
- تقارير مفصلة عن الإلغاءات
- إعدادات قابلة للتخصيص للحدود

## الاختبار

### سيناريوهات الاختبار
1. **اختبار التسجيل**: تأكد من تسجيل الإلغاءات بشكل صحيح
2. **اختبار الحدود**: تأكد من إيقاف الحساب عند الوصول للحد
3. **اختبار التحذيرات**: تأكد من ظهور التحذيرات المناسبة
4. **اختبار الإدارة**: تأكد من عمل لوحة المدير بشكل صحيح
5. **اختبار إعادة الفتح**: تأكد من إمكانية إعادة فتح الحسابات

### بيانات الاختبار
- إنشاء مستخدمين تجريبيين
- إجراء إلغاءات متعددة
- اختبار سيناريوهات مختلفة

## الخلاصة

نظام تتبع الإلغاءات وإيقاف الحسابات يوفر:
- **حماية النظام**: منع الإلغاءات المتكررة
- **تجربة مستخدم محسنة**: تحذيرات واضحة ومفيدة
- **إدارة فعالة**: أدوات شاملة للمديرين
- **شفافية كاملة**: سجلات مفصلة لجميع الإجراءات
- **أمان عالي**: حماية البيانات والخصوصية

هذا النظام يساهم في تحسين جودة الخدمة وتقليل الإلغاءات غير المبررة، مما يؤدي إلى تجربة أفضل لجميع المستخدمين.
