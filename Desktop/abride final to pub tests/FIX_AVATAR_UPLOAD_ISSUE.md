# ุฅุตูุงุญ ูุดููุฉ ุนุฏู ุญูุธ ุงูุตูุฑ ููุฑุงูุจ ูุงูุณุงุฆู

## ุงููุดููุฉ
ุงูุตูุฑ ูุง ุชูุญูุธ ููุฑุงูุจ ูุงูุณุงุฆู ุนูุฏ ุงูุชุณุฌูู ุจุณุจุจ ุฎุทุฃ RLS Policy ูู Supabase Storage.

## ุงูุณุจุจ ุงูุฌุฐุฑู
ุณูุงุณุงุช RLS (Row Level Security) ูู Supabase Storage ูุง ุชุณูุญ ุจุฑูุน ุงูุตูุฑ ูููุณุชุฎุฏููู ุงูุฌุฏุฏ.

## ุงูุญู

### 1. ุชุดุบูู Migration ูู Supabase

**ุงูุฎุทูุฉ ุงูุฃูู:** ูุฌุจ ุชุดุบูู Migration ูุฅุตูุงุญ RLS policies:

1. ุงูุชุญ Supabase SQL Editor:
   **https://supabase.com/dashboard/project/kobsavfggcnfemdzsnpj/editor/sql**

2. ุงุถุบุท **New Query**

3. ุงูุณุฎ ูุญุชูู ุงูููู:
   `supabase/migrations/20260211000002_fix_all_issues.sql`

4. ุงูุตู ูู SQL Editor ูุงุถุบุท **Run**

### 2. ุงูุชุญุณููุงุช ูู ุงูููุฏ

ุชู ุชุญุณูู ููุฏ ุฑูุน ุงูุตูุฑ ูู `SignUp.tsx`:

#### ุฃ. ุฏุงูุฉ `uploadAvatar()`:
- โ ุงูุชุญูู ูู ูุฌูุฏ session ูุดุทุฉ
- โ ูุญุงููุฉ ูุชุนุฏุฏุฉ ููุฑูุน (retry logic)
- โ ูุนุงูุฌุฉ ุฃุฎุทุงุก RLS ุจุดูู ุฃูุถู
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ

#### ุจ. ุฏุงูุฉ `handleAvatarUploadAndUpdate()`:
- โ ุขููุฉ ุฅุนุงุฏุฉ ุงููุญุงููุฉ (3 ูุญุงููุงุช)
- โ ุงูุชุธุงุฑ ุชุฃุณูุณ ุงูุฌูุณุฉ
- โ ุชุญุฏูุซ ุงูุจุฑููุงูู ูุน retry logic
- โ ุฑุณุงุฆู ุชูุถูุญูุฉ ูู console

## ุงูุชุญูู ูู ุงูุฅุตูุงุญ

ุจุนุฏ ุชุดุบูู Migration:

1. โ ุงูุชุญ Console ูู ุงููุชุตูุญ (F12)
2. โ ุฌุฑุจ ุชุณุฌูู ุญุณุงุจ ุฌุฏูุฏ (ุฑุงูุจ ุฃู ุณุงุฆู)
3. โ ุงุฎุชุฑ ุตูุฑุฉ
4. โ ุฑุงูุจ Console - ูุฌุจ ุฃู ุชุฑู:
   - `๐ ุจุฏุก ุฑูุน ุงูุตูุฑุฉ...`
   - `๐ค ุฑูุน ุงูุตูุฑุฉ ุฅูู Supabase Storage...`
   - `โ ุชู ุฑูุน ุงูุตูุฑุฉ ุจูุฌุงุญ!`
   - `๐พ ุญูุธ ุฑุงุจุท ุงูุตูุฑุฉ ูู ุงูุจุฑููุงูู...`
   - `โ ุชู ุญูุธ ุฑุงุจุท ุงูุตูุฑุฉ ูู ุงูุจุฑููุงูู ุจูุฌุงุญ!`

## ุฅุฐุง ูู ูุนูู ุจุนุฏ Migration

ุฅุฐุง ุดุบููุช Migration ููุง ุฒุงูุช ุงููุดููุฉ ููุฌูุฏุฉ:

1. ุชุญูู ูู ูุฌูุฏ bucket `avatars`:
   ```sql
   SELECT * FROM storage.buckets WHERE id = 'avatars';
   ```

2. ุชุญูู ูู ูุฌูุฏ policies:
   ```sql
   SELECT policyname, cmd 
   FROM pg_policies 
   WHERE tablename = 'objects' 
     AND schemaname = 'storage'
     AND policyname LIKE '%vatar%';
   ```

3. ูุฌุจ ุฃู ุชุฑู 4 policies:
   - `Avatar upload for authenticated users` (INSERT)
   - `Avatar read for all` (SELECT)
   - `Avatar update for owner` (UPDATE)
   - `Avatar delete for owner` (DELETE)

## ุงููููุงุช ุงููุนุฏูุฉ

### `src/pages/SignUp.tsx`
- ุชุญุณูู `uploadAvatar()` - ุฅุถุงูุฉ retry logic ู session check
- ุชุญุณูู `handleAvatarUploadAndUpdate()` - ุฅุถุงูุฉ retry logic ูุชุญุฏูุซ ุงูุจุฑููุงูู

### `supabase/migrations/20260211000002_fix_all_issues.sql`
- ุฅุตูุงุญ RLS policies ููุตูุฑ
- ุฅุตูุงุญ constraint ููู category ูู notifications

## ุงููุชูุฌุฉ ุงููุชููุนุฉ

ุจุนุฏ ุชุทุจูู ุงูุฅุตูุงุญุงุช:

โ **ุงูุตูุฑ ุชูุฑูุน ุจูุฌุงุญ** ููุฑุงูุจ ูุงูุณุงุฆู
โ **ุงูุตูุฑ ุชูุญูุธ ูู Supabase Storage** (bucket: avatars)
โ **ุฑุงุจุท ุงูุตูุฑุฉ ููุญูุธ ูู ุงูุจุฑููุงูู** (profiles.avatar_url)
โ **ุงูุตูุฑ ุชุธูุฑ ูู ุงูููู ุงูุดุฎุตู** ููุฑุงูุจ ูุงูุณุงุฆู

---

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 2025-01-19  
**ุงูุญุงูุฉ:** โ ููุชูู - ูุญุชุงุฌ ูุชุดุบูู Migration

