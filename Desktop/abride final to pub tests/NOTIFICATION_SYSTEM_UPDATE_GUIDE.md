# دليل نظام الإشعارات المحدث - أبريداس

## نظرة عامة
تم تحديث نظام الإشعارات في تطبيق أبريداس لضمان عمله بشكل صحيح بين السائق والمستخدم والمدير. النظام الآن يوفر إشعارات شاملة ومتكاملة لجميع الأطراف.

## الميزات الجديدة المضافة

### 1. إشعارات المدير المحسنة
- **إشعارات المستخدمين الجدد**: عند تسجيل مستخدم جديد
- **إشعارات تغيير حالة الرحلة**: عند تغيير حالة الرحلة
- **إشعارات إنشاء الرحلات**: عند إنشاء رحلة جديدة
- **إشعارات النظام**: تنبيهات النظام والأمان

### 2. إشعارات الحجوزات المحسنة
- **إشعارات السائق**: عند إنشاء حجز جديد
- **إشعارات الراكب**: عند تأكيد الحجز
- **إشعارات المدير**: عند إنشاء حجز جديد
- **إشعارات إلغاء الحجز**: لجميع الأطراف

### 3. تحسينات الواجهة
- **عرض الإشعارات في الهيدر**: مع عداد الإشعارات غير المقروءة
- **النقر على الإشعارات**: للانتقال للصفحة ذات الصلة
- **تحديث الإشعارات**: كل 30 ثانية
- **معالجة الأخطاء**: حماية من فشل تحميل الإشعارات

## الملفات المحدثة

### 1. `src/integrations/database/notificationService.ts`
**الإضافات الجديدة:**
- `notifyAdminSystemAlert()` - إشعارات تنبيه النظام للمدير
- `notifyAdminNewUser()` - إشعارات المستخدمين الجدد للمدير
- `notifyAdminTripStatusChange()` - إشعارات تغيير حالة الرحلة للمدير

### 2. `src/integrations/database/browserServices.ts`
**التحسينات:**
- إضافة إشعارات عند إنشاء الملف الشخصي
- إضافة إشعارات عند إنشاء الرحلة
- إضافة إشعارات عند تغيير حالة الرحلة

### 3. `src/components/layout/Header.tsx`
**التحسينات:**
- تحسين تحميل الإشعارات
- إضافة معالجة الأخطاء
- تحسين دالة النقر على الإشعارات

## أنواع الإشعارات

### إشعارات الحجوزات
- `BOOKING_CREATED` - إنشاء حجز جديد
- `BOOKING_CONFIRMED` - تأكيد الحجز
- `BOOKING_CANCELLED` - إلغاء الحجز
- `BOOKING_COMPLETED` - إكمال الحجز

### إشعارات الرحلات
- `TRIP_CREATED` - إنشاء رحلة جديدة
- `TRIP_UPDATED` - تحديث الرحلة
- `TRIP_CANCELLED` - إلغاء الرحلة
- `TRIP_FULL` - الرحلة محجوزة بالكامل

### إشعارات النظام
- `SYSTEM_ALERT` - تنبيه النظام
- `USER_REGISTRATION` - تسجيل مستخدم جديد
- `SECURITY_ALERT` - تنبيه أمني

## كيفية عمل النظام

### 1. إشعارات الحجوزات
```typescript
// عند إنشاء حجز جديد
await NotificationService.notifyBookingCreated({
  bookingId: booking.id,
  passengerId: user.id,
  driverId: trip.driverId,
  tripId: trip.id,
  pickupLocation: pickup,
  destinationLocation: destination,
  seatsBooked: seats,
  totalAmount: amount,
  paymentMethod: method
});
```

### 2. إشعارات المدير
```typescript
// إشعار المدير عن مستخدم جديد
await NotificationService.notifyAdminNewUser({
  userId: profile.id,
  userRole: profile.role,
  userName: profile.fullName,
  userEmail: profile.email
});
```

### 3. إشعارات تغيير حالة الرحلة
```typescript
// إشعار المدير عن تغيير حالة الرحلة
await NotificationService.notifyAdminTripStatusChange({
  tripId: trip.id,
  driverId: trip.driverId,
  driverName: driverName,
  fromLocation: fromLocation,
  toLocation: toLocation,
  oldStatus: oldStatus,
  newStatus: newStatus,
  reason: reason
});
```

## تدفق الإشعارات

### عند إنشاء حجز جديد:
1. **السائق** ← إشعار "حجز جديد" (أولوية عالية)
2. **الراكب** ← إشعار "تم تأكيد حجزك" (أولوية متوسطة)
3. **المدير** ← إشعار "حجز جديد في النظام" (أولوية متوسطة)

### عند تسجيل مستخدم جديد:
1. **المدير** ← إشعار "مستخدم جديد" (أولوية متوسطة)

### عند تغيير حالة الرحلة:
1. **المدير** ← إشعار "تغيير حالة الرحلة" (أولوية متوسطة/عالية)

## عرض الإشعارات

### في الهيدر:
- أيقونة الجرس مع عداد الإشعارات غير المقروءة
- قائمة منسدلة بالإشعارات الأخيرة
- النقر على الإشعار للانتقال للصفحة ذات الصلة

### في لوحة المستخدم:
- إحصائيات الإشعارات (إجمالي، غير مقروء، حديث)
- قائمة كاملة بالإشعارات
- إمكانية تصفية الإشعارات

## الأمان والأداء

### الأمان:
- جميع الإشعارات محمية بـ RLS (Row Level Security)
- المستخدمون يرون إشعاراتهم فقط
- المديرون يرون جميع الإشعارات

### الأداء:
- تحديث الإشعارات كل 30 ثانية
- معالجة الأخطاء لمنع فشل العمليات
- إشعارات غير متزامنة لتجنب التأخير

## الاختبار

### اختبار إشعارات الحجوزات:
1. قم بإنشاء حجز جديد
2. تأكد من وصول الإشعار للسائق
3. تأكد من وصول الإشعار للراكب
4. تأكد من وصول الإشعار للمدير

### اختبار إشعارات المدير:
1. قم بتسجيل مستخدم جديد
2. تأكد من وصول الإشعار للمدير
3. قم بإنشاء رحلة جديدة
4. تأكد من وصول الإشعار للمدير

### اختبار عرض الإشعارات:
1. تأكد من ظهور الإشعارات في الهيدر
2. تأكد من عمل عداد الإشعارات غير المقروءة
3. تأكد من عمل النقر على الإشعارات

## ملاحظات مهمة

- النظام يعمل مع قاعدة البيانات المحلية (localStorage) و Supabase
- جميع الإشعارات محمية من الأخطاء
- النظام يدعم الإشعارات باللغة العربية
- الإشعارات تتضمن رموز تعبيرية لسهولة التمييز
- النظام قابل للتوسع لإضافة أنواع إشعارات جديدة

## الدعم الفني

إذا واجهت أي مشاكل في نظام الإشعارات:
1. تحقق من وحدة التحكم (Console) للأخطاء
2. تأكد من اتصال قاعدة البيانات
3. تحقق من صحة بيانات المستخدم
4. تأكد من وجود مستخدمين بصلاحيات المدير
