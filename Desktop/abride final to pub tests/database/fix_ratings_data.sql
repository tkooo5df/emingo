-- إصلاح بيانات التقييمات التجريبية
-- أولاً، دعنا نتحقق من السائقين الموجودين في النظام

-- عرض السائقين الموجودين
SELECT id, full_name, role FROM profiles WHERE role = 'driver' LIMIT 10;

-- عرض الركاب الموجودين  
SELECT id, full_name, role FROM profiles WHERE role = 'passenger' LIMIT 10;

-- عرض الحجوزات الموجودة
SELECT id, driver_id, passenger_id, status FROM bookings WHERE status = 'completed' LIMIT 10;

-- إذا لم تكن هناك بيانات كافية، سنقوم بإنشاء بيانات تجريبية صحيحة
-- إنشاء سائقين تجريبيين إذا لم يكونوا موجودين
INSERT INTO profiles (id, full_name, email, phone, role, created_at, updated_at) 
VALUES 
    ('11111111-1111-1111-1111-111111111111', 'أحمد محمد', 'ahmed@example.com', '0555123456', 'driver', NOW(), NOW()),
    ('22222222-2222-2222-2222-222222222222', 'محمد علي', 'mohamed@example.com', '0555123457', 'driver', NOW(), NOW()),
    ('33333333-3333-3333-3333-333333333333', 'علي حسن', 'ali@example.com', '0555123458', 'driver', NOW(), NOW())
ON CONFLICT (id) DO NOTHING;

-- إنشاء ركاب تجريبيين إذا لم يكونوا موجودين
INSERT INTO profiles (id, full_name, email, phone, role, created_at, updated_at) 
VALUES 
    ('44444444-4444-4444-4444-444444444444', 'فاطمة أحمد', 'fatima@example.com', '0555123459', 'passenger', NOW(), NOW()),
    ('55555555-5555-5555-5555-555555555555', 'سارة محمد', 'sara@example.com', '0555123460', 'passenger', NOW(), NOW()),
    ('66666666-6666-6666-6666-666666666666', 'نور الدين', 'nour@example.com', '0555123461', 'passenger', NOW(), NOW()),
    ('77777777-7777-7777-7777-777777777777', 'خالد عبدالله', 'khalid@example.com', '0555123462', 'passenger', NOW(), NOW())
ON CONFLICT (id) DO NOTHING;

-- إنشاء حجوزات تجريبية مكتملة إذا لم تكن موجودة
INSERT INTO bookings (id, pickup_location, destination_location, passenger_id, driver_id, seats_booked, total_amount, payment_method, status, created_at, updated_at)
VALUES 
    (1001, 'الجزائر العاصمة', 'وهران', '44444444-4444-4444-4444-444444444444', '11111111-1111-1111-1111-111111111111', 1, 2500, 'cod', 'completed', NOW() - INTERVAL '2 days', NOW()),
    (1002, 'وهران', 'الجزائر العاصمة', '55555555-5555-5555-5555-555555555555', '11111111-1111-1111-1111-111111111111', 1, 2500, 'cod', 'completed', NOW() - INTERVAL '1 day', NOW()),
    (1003, 'الجزائر العاصمة', 'قسنطينة', '66666666-6666-6666-6666-666666666666', '11111111-1111-1111-1111-111111111111', 1, 3000, 'cod', 'completed', NOW() - INTERVAL '5 hours', NOW()),
    (1004, 'قسنطينة', 'الجزائر العاصمة', '77777777-7777-7777-7777-777777777777', '22222222-2222-2222-2222-222222222222', 1, 3000, 'cod', 'completed', NOW() - INTERVAL '3 days', NOW()),
    (1005, 'الجزائر العاصمة', 'عنابة', '44444444-4444-4444-4444-444444444444', '22222222-2222-2222-2222-222222222222', 1, 3500, 'cod', 'completed', NOW() - INTERVAL '1 day', NOW()),
    (1006, 'عنابة', 'الجزائر العاصمة', '55555555-5555-5555-5555-555555555555', '22222222-2222-2222-2222-222222222222', 1, 3500, 'cod', 'completed', NOW() - INTERVAL '6 hours', NOW()),
    (1007, 'الجزائر العاصمة', 'تيزي وزو', '66666666-6666-6666-6666-666666666666', '33333333-3333-3333-3333-333333333333', 1, 2000, 'cod', 'completed', NOW() - INTERVAL '4 days', NOW()),
    (1008, 'تيزي وزو', 'الجزائر العاصمة', '77777777-7777-7777-7777-777777777777', '33333333-3333-3333-3333-333333333333', 1, 2000, 'cod', 'completed', NOW() - INTERVAL '2 days', NOW()),
    (1009, 'الجزائر العاصمة', 'بجاية', '44444444-4444-4444-4444-444444444444', '33333333-3333-3333-3333-333333333333', 1, 2200, 'cod', 'completed', NOW() - INTERVAL '1 day', NOW()),
    (1010, 'بجاية', 'الجزائر العاصمة', '55555555-5555-5555-5555-555555555555', '33333333-3333-3333-3333-333333333333', 1, 2200, 'cod', 'completed', NOW() - INTERVAL '3 hours', NOW()),
    (1011, 'الجزائر العاصمة', 'سطيف', '66666666-6666-6666-6666-666666666666', '11111111-1111-1111-1111-111111111111', 1, 2800, 'cod', 'completed', NOW() - INTERVAL '1 week', NOW()),
    (1012, 'سطيف', 'الجزائر العاصمة', '77777777-7777-7777-7777-777777777777', '22222222-2222-2222-2222-222222222222', 1, 2800, 'cod', 'completed', NOW() - INTERVAL '5 days', NOW()),
    (1013, 'الجزائر العاصمة', 'البليدة', '44444444-4444-4444-4444-444444444444', '33333333-3333-3333-3333-333333333333', 1, 1500, 'cod', 'completed', NOW() - INTERVAL '2 weeks', NOW()),
    (1014, 'البليدة', 'الجزائر العاصمة', '55555555-5555-5555-5555-555555555555', '11111111-1111-1111-1111-111111111111', 1, 1500, 'cod', 'completed', NOW() - INTERVAL '1 week', NOW()),
    (1015, 'الجزائر العاصمة', 'الشلف', '66666666-6666-6666-6666-666666666666', '22222222-2222-2222-2222-222222222222', 1, 1800, 'cod', 'completed', NOW() - INTERVAL '3 days', NOW())
ON CONFLICT (id) DO NOTHING;

-- الآن إدراج التقييمات مع البيانات الصحيحة
INSERT INTO ratings (booking_id, driver_id, passenger_id, rating, comment, created_at) VALUES
-- تقييمات للسائق الأول (أحمد محمد)
(1001, '11111111-1111-1111-1111-111111111111', '44444444-4444-4444-4444-444444444444', 5, 'سائق ممتاز ومهذب جداً، الرحلة كانت مريحة وآمنة', NOW() - INTERVAL '2 days'),
(1002, '11111111-1111-1111-1111-111111111111', '55555555-5555-5555-5555-555555555555', 4, 'جيد جداً، لكن تأخر قليلاً', NOW() - INTERVAL '1 day'),
(1003, '11111111-1111-1111-1111-111111111111', '66666666-6666-6666-6666-666666666666', 5, 'أفضل سائق في المدينة!', NOW() - INTERVAL '5 hours'),

-- تقييمات للسائق الثاني (محمد علي)
(1004, '22222222-2222-2222-2222-222222222222', '77777777-7777-7777-7777-777777777777', 3, 'مقبول، لكن السيارة تحتاج تنظيف', NOW() - INTERVAL '3 days'),
(1005, '22222222-2222-2222-2222-222222222222', '44444444-4444-4444-4444-444444444444', 4, 'سائق محترف، أوصي به', NOW() - INTERVAL '1 day'),
(1006, '22222222-2222-2222-2222-222222222222', '55555555-5555-5555-5555-555555555555', 2, 'لم يكن راضياً عن الخدمة', NOW() - INTERVAL '6 hours'),

-- تقييمات للسائق الثالث (علي حسن)
(1007, '33333333-3333-3333-3333-333333333333', '66666666-6666-6666-6666-666666666666', 5, 'خدمة استثنائية، سائق محترف جداً', NOW() - INTERVAL '4 days'),
(1008, '33333333-3333-3333-3333-333333333333', '77777777-7777-7777-7777-777777777777', 5, 'ممتاز في كل شيء!', NOW() - INTERVAL '2 days'),
(1009, '33333333-3333-3333-3333-333333333333', '44444444-4444-4444-4444-444444444444', 4, 'جيد جداً، أوصي به', NOW() - INTERVAL '1 day'),
(1010, '33333333-3333-3333-3333-333333333333', '55555555-5555-5555-5555-555555555555', 5, 'أفضل تجربة ركوب في حياتي!', NOW() - INTERVAL '3 hours'),

-- تقييمات إضافية متنوعة
(1011, '11111111-1111-1111-1111-111111111111', '66666666-6666-6666-6666-666666666666', 4, 'سائق جيد ومهذب', NOW() - INTERVAL '1 week'),
(1012, '22222222-2222-2222-2222-222222222222', '77777777-7777-7777-7777-777777777777', 3, 'مقبول، لكن يمكن أن يكون أفضل', NOW() - INTERVAL '5 days'),
(1013, '33333333-3333-3333-3333-333333333333', '44444444-4444-4444-4444-444444444444', 5, 'سائق محترف جداً، أوصي به بشدة', NOW() - INTERVAL '2 weeks'),
(1014, '11111111-1111-1111-1111-111111111111', '55555555-5555-5555-5555-555555555555', 4, 'جيد جداً، لكن تأخر قليلاً في الوصول', NOW() - INTERVAL '1 week'),
(1015, '22222222-2222-2222-2222-222222222222', '66666666-6666-6666-6666-666666666666', 2, 'لم أكن راضياً عن الخدمة', NOW() - INTERVAL '3 days');

-- التحقق من النتائج
SELECT 
    p.full_name as "اسم السائق",
    p.average_rating as "متوسط التقييم",
    p.ratings_count as "عدد التقييمات",
    COUNT(r.id) as "تقييمات فعلية"
FROM profiles p
LEFT JOIN ratings r ON p.id = r.driver_id
WHERE p.role = 'driver'
GROUP BY p.id, p.full_name, p.average_rating, p.ratings_count
ORDER BY p.average_rating DESC;
